<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.solarnetwork.central.datum.dao.mybatis.GeneralLocationDatum">

	<!-- 
	   Input props:
			date_field            - the date field to query, e.g. 'day'
			date_field_agg        - the date field to aggregate on , e.g. 'month'
			
		Input params:
			filter.locationIds    - array of location IDs
			filter.sourceIds      - array of source IDs
			range.startDate       - the start date (inclusive)
			range.endDate         - the end date (exclusive)
			range.localStartDate  - the local start date (inclusive)
			range.localEndDate    - the local end date (exclusive)
			filter.startDate      - the start date (inclusive)
			filter.endDate        - the end date (exclusive)
			filter.localStartDate - the local start date (inclusive)
			filter.localEndDate   - the local end date (exclusive)			
			
		Outputs:
			ts_start             - timestamptz
			local_date           - date (or timestamptz if date_field_agg == 'hour')
			loc_id               - bigint
			source_id            - text
			jdata                - jsonb
	 -->
	<sql id="fragment-findall-ReportingGeneralLocationDatum-time-rounded-datum-from">
		FROM (
			SELECT				
				l.time_zone AS time_zone
				<choose>
					<when test="range != null">
						<choose>
							<when test="range.localStartDate != null">
								, date_trunc('${date_field}', #{range.localStartDate,typeHandler=net.solarnetwork.central.dao.mybatis.type.JodaLocalDateTimeTypeHandler,jdbcType=TIMESTAMP}::timestamp) AT TIME ZONE l.time_zone AS ts_start
								, date_trunc('${date_field}', #{range.localEndDate,typeHandler=net.solarnetwork.central.dao.mybatis.type.JodaLocalDateTimeTypeHandler,jdbcType=TIMESTAMP}::timestamp) AT TIME ZONE l.time_zone AS ts_end
							</when>
							<otherwise>
								, date_trunc('${date_field}', #{range.startDate,javaType=org.joda.time.DateTime,jdbcType=TIMESTAMP}::timestamp) AT TIME ZONE l.time_zone AS ts_start
								, date_trunc('${date_field}', #{range.endDate,javaType=org.joda.time.DateTime,jdbcType=TIMESTAMP}::timestamp) AT TIME ZONE l.time_zone AS ts_end
							</otherwise>
						</choose>
					</when>
					<otherwise>
						<choose>
							<when test="filter.localStartDate != null">
								, date_trunc('${date_field}', #{filter.localStartDate,typeHandler=net.solarnetwork.central.dao.mybatis.type.JodaLocalDateTimeTypeHandler,jdbcType=TIMESTAMP}::timestamp) AT TIME ZONE l.time_zone AS ts_start
								, date_trunc('${date_field}', #{filter.localEndDate,typeHandler=net.solarnetwork.central.dao.mybatis.type.JodaLocalDateTimeTypeHandler,jdbcType=TIMESTAMP}::timestamp) AT TIME ZONE l.time_zone AS ts_end
							</when>
							<otherwise>
								, date_trunc('${date_field}', #{filter.startDate,javaType=org.joda.time.DateTime,jdbcType=TIMESTAMP}::timestamp) AT TIME ZONE l.time_zone AS ts_start
								, date_trunc('${date_field}', #{filter.endDate,javaType=org.joda.time.DateTime,jdbcType=TIMESTAMP}::timestamp) AT TIME ZONE l.time_zone AS ts_end
							</otherwise>
						</choose>
					</otherwise>
				</choose>
				, array_agg(DISTINCT l.id) AS loc_ids
			FROM solarnet.sn_loc l
			WHERE l.id = ANY(#{filter.locationIds,jdbcType=ARRAY,typeHandler=net.solarnetwork.central.dao.mybatis.type.LongArrayTypeHandler}::bigint[])
			GROUP BY time_zone
		) r
		INNER JOIN <choose>
				<when test="'${date_field}' == 'hour'">
					solaragg.agg_loc_datum_hourly
				</when>
				<when test="'${date_field}' == 'day'">
					solaragg.agg_loc_datum_daily
				</when>
				<otherwise>
					solaragg.agg_loc_datum_monthly
				</otherwise>
			</choose> datum ON 
			datum.loc_id = ANY(r.loc_ids)
			AND datum.source_id = ANY(#{filter.sourceIds,jdbcType=ARRAY,typeHandler=net.solarnetwork.central.dao.mybatis.type.TextArrayTypeHandler}::text[])
			AND datum.ts_start &gt;= r.ts_start
			AND datum.ts_start &lt; r.ts_end
	</sql>

	<sql id="fragment-findall-ReportingGeneralLocationDatum-time-rounded-datum-agg">
		SELECT 
			date_trunc('${date_field_agg}', datum.ts_start::timestamp) AT TIME ZONE r.time_zone AS ts_start
			, (date_trunc('${date_field_agg}', datum.ts_start::timestamp) AT TIME ZONE r.time_zone)<if test="'${date_field_agg}' != 'hour'">::date</if> AS local_date
			, datum.loc_id
			, datum.source_id
			, solaragg.datum_agg_agg(jsonb_build_object(
				'jdata', solaragg.jdata_from_datum(datum),
				'jmeta', datum.jmeta) ORDER BY datum.ts_start) -> 'jdata' AS jdata
		<include refid="fragment-findall-ReportingGeneralLocationDatum-time-rounded-datum-from"/>
		GROUP BY datum.loc_id, datum.source_id, date_trunc('${date_field_agg}', datum.ts_start::timestamp) AT TIME ZONE r.time_zone
	</sql>
	
	<sql id="fragment-findall-ReportingGeneralLocationDatum-time-rounded-datum">
		SELECT 
			datum.ts_start
			, datum.local_date
			, datum.loc_id
			, datum.source_id
			, solaragg.jdata_from_datum(datum) AS jdata
		<include refid="fragment-findall-ReportingGeneralLocationDatum-time-rounded-datum-from"/>
	</sql>
	
	<!-- Partial days -->
	
	<sql id="findall-GeneralLocationDatum-ReportingGeneralLocationDatum-Day-partial-ranges">
		<foreach collection="ranges" item="range" separator=") UNION ALL (" open="(" close=")">
			<choose>
				<when test="range.aggregation.toString() == 'Hour'">
					<include refid="fragment-findall-ReportingGeneralLocationDatum-time-rounded-datum-agg">
						<property name="date_field" value="hour"/>
						<property name="date_field_agg" value="day"/>
					</include>
				</when>
				<otherwise>
					<include refid="fragment-findall-ReportingGeneralLocationDatum-time-rounded-datum">
						<property name="date_field" value="day"/>
						<property name="date_field_agg" value="day"/>
					</include>
				</otherwise>
			</choose>
		</foreach>
	</sql>
	
	<select id="findall-GeneralLocationDatum-ReportingGeneralLocationDatum-Day-partial-count" resultType="long">
		SELECT count(datum.ts_start)
		FROM (		
			<include refid="findall-GeneralLocationDatum-ReportingGeneralLocationDatum-Day-partial-ranges"/>
		) datum
	</select>

	<select id="findall-GeneralLocationDatum-ReportingGeneralLocationDatum-Day-partial" resultMap="ReportingGeneralLocationDatumMatchResult" fetchSize="250" resultSetType="FORWARD_ONLY">
		SELECT
			<include refid="fragment-GeneralLocationDatum-aggregation-result"/>
		FROM (		
			<include refid="findall-GeneralLocationDatum-ReportingGeneralLocationDatum-Day-partial-ranges"/>
		) datum
		<include refid="fragment-findall-ReportingGeneralLocationDatum-order"/>
	</select>
	
	
	<!-- Partial months -->
	
	<sql id="findall-GeneralLocationDatum-ReportingGeneralLocationDatum-Month-partial-ranges">
		<foreach collection="ranges" item="range" separator=") UNION ALL (" open="(" close=")">
			<choose>
				<when test="range.aggregation.toString() == 'Hour'">
					<include refid="fragment-findall-ReportingGeneralLocationDatum-time-rounded-datum-agg">
						<property name="date_field" value="hour"/>
						<property name="date_field_agg" value="month"/>
					</include>
				</when>
				<when test="range.aggregation.toString() == 'Day'">
					<include refid="fragment-findall-ReportingGeneralLocationDatum-time-rounded-datum-agg">
						<property name="date_field" value="day"/>
						<property name="date_field_agg" value="month"/>
					</include>
				</when>
				<otherwise>
					<include refid="fragment-findall-ReportingGeneralLocationDatum-time-rounded-datum">
						<property name="date_field" value="month"/>
						<property name="date_field_agg" value="month"/>
					</include>
				</otherwise>
			</choose>
		</foreach>
	</sql>
	
	<select id="findall-GeneralLocationDatum-ReportingGeneralLocationDatum-Month-partial-count" resultType="long">
		SELECT count(datum.ts_start)
		FROM (		
			<include refid="findall-GeneralLocationDatum-ReportingGeneralLocationDatum-Month-partial-ranges"/>
		) datum
	</select>

	<select id="findall-GeneralLocationDatum-ReportingGeneralLocationDatum-Month-partial" resultMap="ReportingGeneralLocationDatumMatchResult" fetchSize="250" resultSetType="FORWARD_ONLY">
		SELECT
			<include refid="fragment-GeneralLocationDatum-aggregation-result"/>
		FROM (		
			<include refid="findall-GeneralLocationDatum-ReportingGeneralLocationDatum-Month-partial-ranges"/>
		) datum
		<include refid="fragment-findall-ReportingGeneralLocationDatum-order"/>
	</select>

</mapper>
