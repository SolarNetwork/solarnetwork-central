<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.solarnetwork.central.datum.dao.mybatis.GeneralNodeDatum">

	<select id="find-general-reporting-diff-within" resultMap="ReportingGeneralNodeDatumDirectResult" fetchSize="250" resultSetType="FORWARD_ONLY">
		SELECT
			ts_start,
			ts_start AT TIME ZONE time_zone AS local_date,
			node_id,
			source_id,
			solarcommon.jdata_from_components(NULL, jdata_a, jsonb_build_object(
				'timeZone', time_zone,
				'endDate', to_char(ts_end at time zone 'UTC', 'YYYY-MM-DD HH24:MI:SS.MS"Z"'),
				'localEndDate', to_char(ts_end AT TIME ZONE time_zone, 'YYYY-MM-DD HH24:MI:SS.MS')), NULL) AS jdata
		FROM <choose>
				<when test="tolerance != null">solardatum.calculate_datum_diff</when>
				<otherwise>solardatum.calculate_datum_diff_over</otherwise>
			</choose>(
				#{filter.nodeIds,jdbcType=ARRAY,typeHandler=net.solarnetwork.central.dao.mybatis.type.LongArrayTypeHandler}::bigint[]
				, #{filter.sourceIds,jdbcType=ARRAY,typeHandler=net.solarnetwork.central.dao.mybatis.type.TextArrayTypeHandler}
				, #{start,javaType=org.joda.time.DateTime,jdbcType=TIMESTAMP}
				, #{end,javaType=org.joda.time.DateTime,jdbcType=TIMESTAMP}
			<if test="tolerance != null">
				, #{tolerance,javaType=org.joda.time.Period}::interval
			</if>
			)
		ORDER BY node_id, source_id
	</select>

	<select id="find-general-reporting-diff-within-local" resultMap="ReportingGeneralNodeDatumDirectResult" fetchSize="250" resultSetType="FORWARD_ONLY">
		SELECT
			ts_start,
			ts_start AT TIME ZONE time_zone AS local_date,
			node_id,
			source_id,
			solarcommon.jdata_from_components(NULL, jdata_a, jsonb_build_object(
				'timeZone', time_zone,
				'endDate', to_char(ts_end at time zone 'UTC', 'YYYY-MM-DD HH24:MI:SS.MS"Z"'),
				'localEndDate', to_char(ts_end AT TIME ZONE time_zone, 'YYYY-MM-DD HH24:MI:SS.MS')), NULL) AS jdata
		FROM <choose>
				<when test="tolerance != null">solardatum.calculate_datum_diff_local</when>
				<otherwise>solardatum.calculate_datum_diff_over_local</otherwise>
			</choose>(
				#{filter.nodeIds,jdbcType=ARRAY,typeHandler=net.solarnetwork.central.dao.mybatis.type.LongArrayTypeHandler}::bigint[]
				, #{filter.sourceIds,jdbcType=ARRAY,typeHandler=net.solarnetwork.central.dao.mybatis.type.TextArrayTypeHandler}
				, #{start,typeHandler=net.solarnetwork.central.dao.mybatis.type.JodaLocalDateTimeTypeHandler,jdbcType=TIMESTAMP}::timestamp
				, #{end,typeHandler=net.solarnetwork.central.dao.mybatis.type.JodaLocalDateTimeTypeHandler,jdbcType=TIMESTAMP}::timestamp
			<if test="tolerance != null">
				, #{tolerance,javaType=org.joda.time.Period}::interval
			</if>
			)
		ORDER BY node_id, source_id
	</select>

</mapper>
