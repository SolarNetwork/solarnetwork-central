plugins {
	id 'java'
    id 'eclipse'
	id 'org.springframework.boot' version '4.0.1'
	id 'org.graalvm.buildtools.native' version '0.11.1'
}

apply plugin: 'java'
apply plugin: 'org.springframework.boot'
apply plugin: 'io.spring.dependency-management'
apply plugin: 'org.graalvm.buildtools.native'

description = 'SolarFlux VerneMQ Webhook'
version = '5.0.0'

dependencies {
	implementation project(':solarnet-common')
	implementation project(':solarnet-common-web')

	implementation "org.springframework.boot:spring-boot-starter"
	implementation "org.springframework.boot:spring-boot-starter-cache"
	implementation "org.springframework.boot:spring-boot-starter-jdbc"
	implementation "org.springframework.boot:spring-boot-starter-webmvc"

	// DB
	runtimeOnly 'org.postgresql:postgresql'
	implementation 'org.apache.tomcat:tomcat-jdbc'
		
	// JCache
	implementation 'javax.cache:cache-api'
	implementation 'org.ehcache:ehcache'

	// JSON
	implementation "com.fasterxml.jackson.core:jackson-annotations"
	implementation "tools.jackson.core:jackson-core"
	implementation "tools.jackson.core:jackson-databind"

	// Utils
    implementation 'com.github.veqryn:cidr-ip-trie:1.0.1'
    
    // Testing
	testImplementation project(':solarnet-common-test')
	testImplementation "org.springframework.boot:spring-boot-starter-jdbc-test"
	testImplementation "org.springframework.boot:spring-boot-starter-webmvc-test"
}

configurations.configureEach {
	exclude group: 'com.fasterxml.jackson.datatype', module: 'jackson-datatype-joda'
	exclude group: 'com.zaxxer', module: 'HikariCP'
	exclude group: 'io.netty'
	exclude group: 'net.solarnetwork.common', module: 'net.solarnetwork.common.mqtt'
	exclude group: 'net.solarnetwork.common', module: 'net.solarnetwork.common.pki.bc'
	exclude group: 'org.apache.commons', module: 'commons-compress'
	exclude group: 'org.eclipse.virgo.mirrored'
	exclude group: 'org.mybatis'
	exclude group: 'org.mybatis.spring.boot', module: 'mybatis-spring-boot-starter'
	exclude group: 'org.osgi'
	exclude group: 'org.osgi.core'
	exclude group: 'org.osgi.enterprise'
	exclude group: 'org.springframework', module: 'spring-messaging'
	exclude group: 'org.springframework', module: 'spring-websocket'
	exclude group: 'org.springframework.security'
	exclude group: 'org.springframework.boot', module: 'spring-boot-security'
	exclude group: 'org.springframework.boot', module: 'spring-boot-security-test'
	exclude group: 'software.amazon.awssdk'
}

bootJar {
	manifest {
		attributes 	'Implementation-Title': 'SolarFlux VerneMQ Webhook Server',
					'Implementation-Version': archiveVersion
	}
}

graalvmNative {
	binaries.all {
		buildArgs.add('--enable-native-access=ALL-UNNAMED')
		buildArgs.add('-O3')
	}
	
	binaries.main {
		imageName = 'solarflux-webhook'
	}
}

tasks.withType(org.springframework.boot.gradle.tasks.aot.ProcessAot).configureEach {
    args('--spring.profiles.active=production')
}
